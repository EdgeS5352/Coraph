#!/bin/bash -e
#(C)Code by Solaris Eco 2020
#Blog:https://edges5352.github.io
#Email:bluebreeze191@gamil.com
#GitHub:EdgeS5352 (Solaris Eco)
#coding:UTF-8


#some path
export bin="$PREFIX/bin/"
export output="/dev/null/"
export import_list="$PREFIX/etc/coraph.conf"
export base="~/coraph/"

#some color
yellow="\033[33m"
red="\033[31m"
green="\033[32m"
suffix="\033[0m"


#import some argument
if [ -f $import_list ]; then
  export ubuntu=`sed -n "3,3p" $import_list`
  export arch=`sed -n "6,6p" $import_list`
  export fedora=`sed -n "9,9p" $import_list`
  export centos=`sed -n "12,12p" $import_list`
  export debian=`sed -n "15,15p" $import_list`
  export kali=`sed -n "18,18p" $import_list`
else
  echo "${red} $import_list does not exist! ${suffix}"
  exit "2"
fi


#some tips
export version="v0.6"
export download_tip="echo -e ${green}Downloading Rootfs,this may take some time...${suffix}"
export void_error="echo -e ${red}Please input a effective argument!${suffix}"
export unpack_tip="echo -e ${green}Unpacking,please waiting...${suffix}"
export done_tip="echo -e ${green} Process done! ${suffix} "
export introduce="echo Coraph is a useful tool which can help you to set up some  Linux Distribution in your Termux."


#some links
export ubuntu_link="wget ${ubuntu}"
export arch_link="wget ${arch}"
export fedora_link="wget ${fedora}"
export centos_link="wget ${centos}"
export debian_link="wget ${debian}"
export kali_link="wget ${kali}"


#some function
function check_exist {
if [ -f "$bin$2" ]; then
  echo -e "${red} You are been installed this DISTRIBUTION! ${suffix}"
  exit "2"
fi
}

function logo {
clear
echo -e "${yellow}          ____                      _                ${suffix}"
echo -e "${yellow}         / ___|___  _ __ __ _ _ __ | |__             ${suffix}"
echo -e "${yellow}        | |   / _ \|  __/ _  |  _ \|   _ \           ${suffix}"
echo -e "${yellow}        | |__| (_) | | | (_| | |_) | | | |           ${suffix}"
echo -e "${yellow}         \____\___/|_|  \__,_| .__/|_| |_|           ${suffix}"
echo -e "${yellow}                              |_|         ${version} ${suffix}"
echo ""
echo "            https://github.com/EdgeS5352/Coraph"
echo ""
echo ""
}


#do you have proot?
proot=`which proot`
if [ x"$proot" = x ]; then
  echo "${green} Installing proot... ${suffix}"
  apt install proot -y 1>"$output" 2>&1
fi

#move
rename="mv rootfs.tar.xz $2.tar.xz && mv $2.tar.xz ~"


#haven't input
if [ x"$1" == x ]; then
  logo
  ${introduce}


#install a system
elif [ $1 == "deploy" ]; then
  case $2 in
  "ubuntu")
  logo
  check_exist
  ${download_tip}
  ${ubuntu_link}
  ;;  
  "arch")
  logo
  check_exist
  ${download_tip}
  ${arch_link}
  ;;
  "fedora")
  logo
  check_exist
  ${download_tip}
  ${fedora_link}
  ;;
  "centos")
  logo
  check_exist
  ${download_tip}
  ${centos_link}
  ;;
  "debian")
  logo
  check_exist
  ${download_tip}
  ${debian_link}
  ;;
  "kali")
  logo
  check_exist
  ${download_tip}
  ${kali_link}
  ;;
  "*")
  ${void_error}
  exit "2"
  ;; 
  esac
  

  #Global setting
  ${rename}
  mkdir ~/.coraph 1>"$output" 2>&1
  mv $2.tar.xz ~/.coraph/
  cd ~/.coraph/
  ${unpack_tip}
  xz -d $2.tar.xz
  tar -xvf $2.tar
  echo -e "${green} Start to remove compression package... ${suffix}"
  rm ~/.coraph/$2.tar
  echo -e "${green} Write launch script in $bin$2 ${suffix}"
  cd $PREFIX/bin
  touch $2
  echo -e "${green} Chinese(zh_CN) ${suffix}"  
  echo -e "${green} English(C) ${suffix}"
  read -p "which is your language (cn/en)" lang
  if [ $lang == "cn" ]; then
    setting="zh_CN.UTF-8"
  elif [ $lang == "en" ]; then
    setting="C.UTF-8"
  else
    ${void_error}
  fi 

  #Write script
  dir="~/.coraph/$2"
  echo -e "#! /bin/bash\nunset LD_PRELOAD\nproot --link2symlink -S ${dir} -b /sys -b /dev -b /proc -b ~/ -w /root /usr/bin/env -i HOME=/root LANG=${setting} PATH=/bin:/usr/bin:/sbin:/usr/sbin:/usr/local/bin:/usr/local/sbin TERM=xterm-256color /bin/bash --login" > "$bin$2"
  chmod +x $bin$2
  ${done_tip}
  echo -e "${green} Now you can launch $2 with command [$2]. ${suffix}"
  exit "0"


#remove a system
elif [ $1 == "remove" ]; then
  logo
  read -p "Are you sure you want to remove $2 (y/n)ï¼š" chose
  if [ $chose == "Y" -o $chose == "y" ]; then    
    echo "${green} Start to remove $2... ${suffix}"
    if [ x"$2" == x ]; then
      ${void_error}
      exit "2"
    fi
    if [ -f "$base$2" ]; then
    rm -rf $base$2
    else
    echo "${red} You didn't install $2! ${suffix}"
    fi
    rm -rf $bin$2
    ${done_tip}
  elif [ $chose == "N" -o $chose == "n" ]; then
    echo -e "${green} abort. ${suffix}"
    exit "0"
  else
    echo -e "${red} Command not found. ${suffix}"
  fi


#help info
elif [ $1 == "help" ]; then
  echo "Coraph          ${version}"
  echo "Usage: coraph [command] [argument]"
  echo ""
  ${introduce}
  echo ""
  echo "Command:"
  echo "deploy          to install a Linux distribution which you need"
  echo "remove          delete a existing Linux distribution"
  echo "update          get the latest version of Coraph"
  echo "list            list all of rootfs which can be support"
  echo "help            get some help"


else
echo "coming soon"
fi
